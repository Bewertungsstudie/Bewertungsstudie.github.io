<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Umfrage-Verteiler</title>
  <script>
    const API_KEY = "ut_9LCqOv31LX56PG9NDrNqksGhtEsPz1jFg4tKdKQa"; // <-- hier einfügen
    
    const links = [
      ["https://survey.questionstar.com/cb99420f", "countera"],
      ["https://survey.questionstar.com/9f6bf697", "counterb"],
      ["https://survey.questionstar.com/172443bb", "counterc"],
      ["https://survey.questionstar.com/2daa4b2d", "counterd"],
      ["https://survey.questionstar.com/b0c109f6", "countere"],
      ["https://survey.questionstar.com/9e704022", "counterf"]
    ];

    async function getTotalCount(){      
      // Lade die bisherigen Zählstände oder setze auf 0
      let res = await fetch(`https://api.counterapi.dev/v2//bewertungsstudie/countertotal}`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${API_KEY}`,
          "Content-Type": "application/json"
        }
      });
      return res.json().data?.up_count ?? 0;    
    }
    
    const totalCount = getTotalCount();

    // Fetch up_count for all counters
    async function fetchCounts() {
      const counts = await Promise.all(
        links.map(async ([_, counterName]) => {
          try {
            const res = await fetch(`https://api.counterapi.dev/v2/bewertungsstudie/${counterName}`, {
              method: "GET",
              headers: {
                "Authorization": `Bearer ${API_KEY}`,
                "Content-Type": "application/json"
              }
            });
            if (!res.ok) throw new Error(`Failed to fetch counter: ${counterName}`);
            const json = await res.json();
            return json?.data?.up_count ?? 0; // fallback to 0 if undefined
          } catch (err) {
            console.error(err);
            return 0;
          }
        })
      );
    
      return counts;
    }
    
    // Pick a random index among links with the lowest count
    function getNextIndex(counts) {
      const min = Math.min(...counts);
      const indices = counts.map((c, i) => (c === min ? i : -1)).filter(i => i !== -1);
      return indices[Math.floor(Math.random() * indices.length)];
    }

    async function redirectToSurvey() {
      const idx = getNextIndex();      
      const [link, counterName] = links[index];
    
      try {        
        // Increment the counter
        const res = await fetch(`https://api.counterapi.dev/v2/bewertungsstudie/${counterName}/up`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          }
        });
    
        if (!res.ok) throw new Error(`Failed to increment counter: ${counterName}`);
        console.log(`Counter ${counterName} incremented.`);

        const res2 = await fetch(`https://api.counterapi.dev/v2/bewertungsstudie/countertotal/up`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          }
        });

        if (!res2.ok) throw new Error(`Failed to increment counter: ${counterName}`);
        console.log(`Counter ${counterName} incremented.`);
            
        // Redirect to the survey link
        window.location.href = link;
    
      } catch (err) {
        console.error(err);
        alert("Something went wrong. Please try again.");
      }
    }
    
    const counts = fetchCounts();
    const index = getNextIndex(counts);
    const [link, counterName] = links[index];
    // Automatische Weiterleitung
    window.onload = redirectToSurvey();
  </script>
</head>
<body>
  <p>Du wirst gleich weitergeleitet ...</p>
</body>
</html>
